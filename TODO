1
// `src/service/geoService.ts` (TypeScript)
// vérifie/demande les permissions puis retourne la position ou null
import { Geolocation, PermissionStatus } from '@capacitor/geolocation';

export const ensureLocationPermission = async (): Promise<boolean> => {
  try {
    const status: PermissionStatus = await Geolocation.checkPermissions();
    if (status.location === 'granted') return true;

    const req = await Geolocation.requestPermissions();
    return req.location === 'granted';
  } catch (e) {
    console.error('Erreur permission géoloc', e);
    return false;
  }
};

export const getCurrentPosition = async (): Promise<{ lat: number; lng: number } | null> => {
  const ok = await ensureLocationPermission();
  if (!ok) return null;
  try {
    const pos = await Geolocation.getCurrentPosition({ timeout: 10000 });
    return { lat: pos.coords.latitude, lng: pos.coords.longitude };
  } catch (e) {
    console.error('Erreur récupération position', e);
    return null;
  }
};

/* === Native changes ===
 After editing, run:
   npx cap sync android
   npx cap sync ios
 and rebuild the apps (Android Studio / Xcode).
*/

/* `android/app/src/main/AndroidManifest.xml` (ajouter les lignes <uses-permission> dans <manifest>) */
<!--
  <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
  <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
  <!-- si besoin de localisation en arrière-plan (Android 10+), ajouter :
  <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
  -->
-->

/* `ios/App/App/Info.plist` (ajouter ces clés pour iOS) */
<!--
  <key>NSLocationWhenInUseUsageDescription</key>
  <string>Nous utilisons votre position pour centrer la carte.</string>
  <!-- si besoin d'accès en arrière-plan -->
  <key>NSLocationAlwaysAndWhenInUseUsageDescription</key>
  <string>Nous utilisons la localisation en arrière-plan pour ...</string>
-->

/* Notes rapides :
 - Pour accès en arrière-plan iOS : activer Background Modes > Location updates dans Xcode.
 - Sur Android 11+ et target SDK récents, la permission background demande un flux UX spécifique ; testez sur appareil réel.
 - Toujours tester le flux 'autoriser/refuser' et gérer le cas où l'utilisateur refuse (montrer un message ou rediriger vers les réglages).
*/


